/*
Copyright (c) 2013 SPC
Date:2013-06-05
example:
var $select = $("#...").smartFilterSelect({width:140,height:20,divHeight:300,defaultLabel:"全部"});
如果该下拉列表需要处理change事件，则需要在$("#...").change(function(){...});中首先执行如下一行代码：
$select.resetSmartFilterSelectHandleFlag();

如果数据是异步加载的，则需要在被异步加载的地方调用 T.resetSmartFilterSelect();函数.
 */
(function(a) {
    a.fn.smartFilterSelect = function(c) {
        var c = a.extend({
            width: 140,
            height: 20,
            divHeight: 300,
            defaultLabel: ""
        }, c);
        var l = function j(x) {
            var v = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"];
            var u = "";
            for (var t = 0; t < x; t++) {
                var w = Math.ceil(Math.random() * 35);
                u += v[w]
            }
            return u
        };
        var f = new Array();
        var h;
        var o;
        var n = "smartFilterSelectText_id_" + l(10);
        var q = "smartFilterSelectDiv_id_" + l(10);
        var r;
        var e = false;
        var b = function s(u) {
            var t = f.length;
            if (t != 0) {
                u.show();
                a("#" + q).show()
            } else {
                u.each(function() {
                    a(this).children("option:gt(0)").each(function() {
                        f.push([a(this).text(), a(this).val()])
                    })
                });
                u.show();
                a("#" + q).show()
            }
        };
        var k = function m(v) {
            v.empty();
            var u = f.length;
            if (u != 0) {
                v.append(a("<option/>").val("").text(c.defaultLabel));
                for (var t = 0; t < u; t++) {
                    v.append(a("<option/>").val(f[t][1]).text(f[t][0]))
                }
                v.show();
                a("#" + q).show()
            }
        };
        var p = function(t) {
            return g(t, "offsetLeft")
        };
        var i = function(t) {
            return g(t, "offsetTop")
        };
        var g = function(u, t) {
            var v = 0;
            while (u) {
                v += u[t];
                u = u.offsetParent
            }
            return v
        };
        var d = function(w) {
            h = a("<input />").attr("type", "text").attr("id", n);
            o = a("<div />").attr("id", q).css("position", "absolute").css("z-index", "9999").css("display", "none");
            w.attr("multiple", "multiple").css("display", "none");
            w.before(h);
            w.wrap(o);
            var t = h[0].offsetWidth;
            var v = p(h[0]);
            var u = 0;
            if($('.poslist_trend_select').hasClass('f-notLeft') ){
            	u = i(h[0]);
            }else{
            	u = i(h[0]) + h[0].offsetHeight;
            }
            a("#" + q).css("left", v);
            a("#" + q).css("top", u);
            w.width(t).height(c.divHeight);
            r = w.parents("form").eq(0);
            r.attr("autocomplete", "off");
            r.keydown(function(x) {
                if (x.keyCode == 13) {
                    return false
                }
            });
            h.val(w.find("option:selected").text());
            w.each(function() {
                a(this).children("option:gt(0)").each(function() {
                    f.push([a(this).text(), a(this).val()])
                })
            })
        };
        this.resetSmartFilterSelectHandleFlag = function() {
            e = true
        };
        this.resetSmartFilterSelect = function() {
            h.val(c.defaultLabel);
            f = new Array()
        };
        return this.each(function() {
            var t = a(this);
            d(t);
            h.focus(function() {
                e = false;
                h.select();
                b(t)
            }).blur(function() {});
            h.keydown(function(u) {
                if (u.keyCode == 40 || u.keyCode == 38 || u.keyCode == 37 || u.keyCode == 39) {
                    e = false;
                    t.focus()
                }
            });
            h.keyup(function(x) {
                var w = a.trim(h.val());
                var u = false;
                t.val("");
                if (w != null && w != "") {
                    t.empty().hide();
                    a("#" + q).hide();
                    t.append(a("<option/>").val("").text(c.defaultLabel));
                    for (var v = 0; v < f.length; v++) {
                        if (f[v][0].slice(0, w.length) == w) {
                            u = true;
                            t.append(a("<option/>").val(f[v][1]).text(f[v][0]))
                        }
                    }
                    if (u) {
                        t.show();
                        a("#" + q).show()
                    }
                } else {
                    if (x.keyCode == 8 || x.keyCode == 46) {
                        k(t)
                    }
                }
            });
            a(document).click(function(v) {
                var u = a(v.target);
                if (!u.is("#" + n) && !u.is("#" + q)) {
                    t.hide();
                    a("#" + q).hide()
                }
            });
            t.click(function() {
                if (a.browser.msie && a.browser.version == "6.0") {
                    setTimeout(function() {
                        h.val(t.find("option:selected").text());
                        t.hide();
                        a("#" + q).hide();
                        if (!e) {
                            t.trigger("change")
                        }
                    }, 1)
                } else {
                    h.val(t.find("option:selected").text());
                    t.hide();
                    a("#" + q).hide();
                    if (!e) {
                        t.trigger("change")
                    }
                }
            }).keydown(function(u) {
                if (u.keyCode == 13) {
                    if (a.browser.msie && a.browser.version == "6.0") {
                        setTimeout(function() {
                            h.val(t.find("option:selected").text());
                            t.hide();
                            a("#" + q).hide();
                            if (!e) {
                                t.trigger("change")
                            }
                        }, 1)
                    } else {
                        h.val(t.find("option:selected").text());
                        t.hide();
                        a("#" + q).hide();
                        if (!e) {
                            t.trigger("change")
                        }
                    }
                }
            })
        })
    }
})(jQuery);