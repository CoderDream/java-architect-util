

# 第7章　精通监听器

监听器是一个对象，以key-value的形式表示。key是需要监听的表达式，value是对应的回调函数。value也可以是方法名，或者包含选项的对象。Vue实例将会在实例化时调用$watch()遍历watch对象的每一个property。同时，当差值数据变化时，执行异步或开销较大的操作时，可以通过采用监听器的方式来达到目的。本章将讲解监听器对象的用法。

## 7.1　使用监听器

监听器在Vue实例的watch选项中定义。它包括两个参数，第一个参数是监听数据的新值，第二个是旧值。

下面示例监听了data()函数中的message属性，并在控制台中打印新值和旧值。

【例7.1】使用监听器（源代码\ch07\7.1.html）。

```html

```

在浏览器中运行程序，这里将分别监听数据属性time和minute的变化，当其中一个数据的值发生变化时，就会调用对应的监听器，经过计算得到另一个数据属性的值，结果如图7-1所示。

[插图]

图7-1　监听属性值的变化

注意，不要用箭头函数来定义watch函数。例如：

```html

```

因为箭头函数绑定了父级作用域的上下文，所以this将不会按照期望指向Vue实例，this.time和this.minute都是undefined。

## 7.2　监听方法

在使用监听器的时候，除了直接写一个监听处理函数外，还可以接收一个加字符串形式的方法名，方法在methods选项中定义。

【例7.2】使用监听器方法（源代码\ch07\7.2.html）。

在示例中监听了yuan和jiao属性，后面直接加上字符串形式的方法名method1和method2，最后在页面中使用v-model指令绑定yuan和jiao属性。

```html

```

在浏览器中运行程序，在第一个输入框中输入6，可以发现第二个输入框的值相应地变为60，如图7-2所示。同样，在第二个输入框中输入内容，第一个输入框也会相应地变化。



图7-2　监听方法

## 7.3　监听对象

当监听器监听一个对象时，使用handler定义数据变化时调用的监听器函数，还可以设置deep和immediate属性。

deep属性在监听对象属性变化时使用，该选项的值为true，表示无论该对象的属性在对象中的层级有多深，只要该属性的值发生变化，都会被监测到。

监听器函数在初始渲染时并不会被调用，只有在后续监听的属性发生变化时才会被调用；如果需要监听器函数在监听开始后立即执行，可以使用immediate选项，将其值设置为true。

下面示例监听一个goods对象，在商品价格改变时显示是否可以采购。

【例7.3】监听对象（源代码\ch07\7.3.html）。

```html

```

在浏览器中运行程序，在输入框中输入860，下面会显示“价格合适，可以采购！”，如图7-3所示；修改为8600，下面会变成“价格太贵了，不可以采购！”，如图7-4所示。



在浏览器中运行程序，在输入框中输入860，下面会显示“价格合适，可以采购！”，如图7-3所示；修改为8600，下面会变成“价格太贵了，不可以采购！”，如图7-4所示。

[插图]

图7-3　输入“860”效果

[插图]

图7-4　输入“8600”效果

从上面示例可以发现，页面初始化时监听器不会被调用，只有在监听的属性发生变化时才会被调用；如果要让监听器函数在页面初始化时执行，可以使用immediate选项，将其值设置为true。

[插图]

此时在浏览器中运行程序，可以发现，虽然没有改变属性值，也调用了回调函数，显示了“价格合适，可以采购！”，如图7-5所示。

[插图]

图7-5　immediate选项的作用

在上面的示例中，使用deep属性深入监听，监听器会一层层地往下遍历，给对象的所有属性都加上这个监听器，修改对象里面任何一个属性都会触发监听器里的handler函数。

在实际开发过程中，用户很可能只需要监听对象中的某几个属性，设置deep:true之后就会增大程序性能的开销。这里可以直接监听想要监听的属性，例如修改上面示例，只监听score属性。

【例7.4】监听器对象的单个属性（源代码\ch07\7.4.html）。

```html

```

在浏览器中运行程序，在输入框中输入“北京”，结果如图7-6所示；在输入框中输入“上海”，结果如图7-7所示。

[插图]

图7-6　输入“北京”的效果

[插图]

图7-7　输入“上海”的效果

> 

提示：

监听对象的属性时，因为使用了点号（.），所以要使用单引号（''）或双引号（""）将其包裹起来，例如"'goods.city'"。

## 7.4　综合案例——使用监听器设计购物车效果

本节将使用监听器设计购物车效果，这个购物车需要满足以下需求：

（1）当用户每次修改预购买商品名称的时候，都需要清空购买数量。

（2）对购物车数据进行侦听，每次单击“加入购物车”按钮，会显示商品名称和数量。

【例7.5】设计购物车效果（源代码\ch07\7.5.html）。

```html

```

在浏览器中运行程序，输入商品名称后多次单击“加一个”按钮，然后单击“加入购物车”按钮，结果如图7-8所示。

[插图]

图7-8　购物车效果

## 7.5　疑难解惑

疑问1：什么时候需要使用监听器？

当需要在数据变化时执行异步或开销较大的操作时，使用监听器比较合适。例如，在一个学习资料搜索系统中，用户输入的问题需要从服务器的数据库中获取相应的资料，就可以对问题属性进行监听。在异步请求学习资料的过程中，可以设置中间专题，向用户提示“请稍后，正在搜索中”。

疑问2：计算属性和监听器有何不同？

Vue的计算属性主要用于同步对数据的处理，而监听器主要用于事件的同步或异步。它们的主要区别如下：

（1）计算属性拥有缓存属性，只有当依赖的数据发生变化时，关联的数据才会变化，适用于计算或者格式化数据的场景。

（2）监听器用于监听数据，有关联但是没有依赖，只要某个数据发生变化，就可以处理一些数据并同步或异步执行。
