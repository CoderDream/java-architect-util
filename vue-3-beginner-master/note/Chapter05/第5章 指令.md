# 第5章 指令

指令是Vue模板中最常用的一项功能，它带有前缀v-，主要职责是当其表达式的值改变时，相应地将某些行为应用在DOM上。本章将介绍Vue的内置指令，以及自定义指令的注册与使用。

## 5.1　内置指令

内置指令顾名思义就是Vue内置的一些指令，它是针对一些常用的页面功能提供了以指令来封装的使用形式，以HTML属性的方式使用。

### 5.1.1　v-show

v-show指令会根据表达式的真假值，切换元素的display CSS属性，来显示或者隐藏元素。当条件变化时，该指令会自动触发过渡效果。

【例5.1】v-show指令（源代码\ch05\5.1.html）。

```html
<div id="app">
    <h3 v-show="ok">西瓜</h3>
    <h3 v-show="no">苹果</h3>
    <h3 v-show="num>=1000">库存很充足！</h3>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                ok: true,
                no: false,
                num: 1000
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，按F12键打开控制台并切换到“Elements”选项，展开<div>标签，结果如图5-1所示。

![](assets\CB_3300020858_Figure-P70_20801.jpg)

图5-1　v-show指令

从上面的示例可以发现，“苹果”并没有显示，是因为v-show指令计算“no”的值为false，所以元素不会显示。

在浏览器的控制台中可以看到，使用v-show指令，元素本身是被渲染到页面的，只是通过CSS的display属性来控制元素的显示或者隐藏。如果v-show指令计算的结果为false，则设置器样式为“display:none;”。

在浏览器的控制台中，双击代码后修改“苹果”一栏中display为true，可以发现页面中就显示了苹果，如图5-2所示。

![](assets\CB_3300020858_Figure-P70_20805.jpg)

图5-2　修改“苹果”一栏中display为true

### 5.1.2　v-if/v-else-if/v-else

在Vue中使用v-if、v-else-if和v-else指令实现条件判断。

1．v-if指令

v-if指令根据表达式的真假来有条件地渲染元素。

【例5.2】v-if指令（源代码\ch05\5.2.html）。

```html
<div id="app">
    <h3 v-if="ok">冰箱</h3>
    <h3 v-if="no">洗衣机</h3>
    <h3 v-if="num>=1000">库存很充足！</h3>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                ok: true,
                no: false,
                num: 1000
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，按F12键打开控制台并切换到“Elements”选项，结果如图5-3所示。

![](assets\CB_3300020858_Figure-P71_21248.jpg)

图5-3　v-if指令

在上面示例中，使用v-if="no"的元素并没有被渲染，使用v-if="ok"的元素正常渲染了。也就是说，当表达式的值为false时，v-if指令不会创建该元素，只有当表达式的值为true时，v-if指令才会真正创建该元素。这与v-show指令不同，v-show指令不管表达式的真假，元素本身都会被创建，显示与否是通过CSS的样式属性display来控制的。

一般来说，v-if有更高的切换开销，而v-show有更高的初始渲染开销。因此，如果需要非常频繁地切换，则使用v-show较好；如果在运行时条件很少改变，则使用v-if指令较好。

2．v-else-if/v-else指令

v-else-if指令与v-if指令一起使用，用法与JavaScript中的if…else if类似。

下面示例使用v-else-if指令与v-if指令判断学生成绩对应的等级。

【例5.3】v-else-if指令与v-if指令（源代码\ch05\5.3.html）。

```html
<div id="app">
    <span v-if="score>=90">优秀</span>
    <span v-else-if="score>=80">合格</span>
    <span v-else-if="score>=60">及格</span>
    <span v-else>不及格</span>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                ok: true,
                no: false,
                score: 85
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，按F12键打开控制台并切换到“Elements”选项，结果如图5-4所示。

![[插图]](assets\CB_3300020858_Figure-P72_21723.jpg)

图5-4　v-else-if指令与v-if指令

在上面示例中，当满足其中一个条件后，程序就不会再往下执行。使用v-else-if和v-else指令时，它们要紧跟在v-if或者v-else-if指令之后。

### 5.1.3　v-for

使用v-for指令可以对数组、对象进行循环，来获取到其中的每一个值。

1．v-for指令遍历数组

使用v-for指令，必须使用特定语法alias in expression，其中items是源数据数组，而item则是被迭代的数组元素的别名，具体格式如下：

```html
<div v-for="item in items">
    {{ item }}
</div>
```

下面看一个示例，使用v-for指令循环渲染一个数组。

【例5.4】v-for指令遍历数组（源代码\ch05\5.4.html）。

```html
<div id="app">
    <ul>
        <li v-for="item in nameList">
            {{item.name}}--{{item.city}}--{{item.price}}元
        </li>
    </ul>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                nameList: [
                    {name: '洗衣机', city: '上海', price: '8600'},
                    {name: '冰箱', city: '北京', price: '6800'},
                    {name: '空调', city: '广州', price: '5900'}
                ]
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，按F12键打开控制台并切换到“Elements”选项，结果如图5-5所示。

![[插图]](assets\CB_3300020858_Figure-P73_22306.jpg)

图5-5　v-for指令遍历数组

> 提示：v-for指令的语法结构也可以使用of替代in作为分隔符，例如：
>
> ```
> <li v-for="item of nameList">
> ```

在v-for指令中，可以访问所有父作用域的属性。v-for还支持一个可选的第二个参数，即当前项的索引。例如，修改上面示例，添加index参数，代码如下：

```html
<ul>
    <li v-for="item in nameList">
        {{item.name}}--{{item.city}}--{{item.price}}元
    </li>
</ul>
```

在浏览器中运行程序，结果如图5-6所示。

![](assets\CB_3300020858_Figure-P74_22434.jpg)

图5-6　v-for指令第二个参数

2．v-for指令遍历对象

遍历对象的语法和遍历数组的语法是一样的：

```html
value in object
```

其中object是被迭代的对象，value是被迭代的对象属性的别名。

【例5.5】v-for指令遍历对象（源代码\ch05\5.5.html）。

```html
<div id="app">
    <ul>
        <li v-for="item in nameObj">
            {{item}}
        </li>
    </ul>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                nameObj: {
                    name: "洗衣机",
                    city: "上海",
                    price: "6800元"
                }
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-7所示。

![](assets\CB_3300020858_Figure-P75_22948.jpg)

图5-7　v-for指令遍历对象

还可以添加第二个参数，用来获取键值；获取选项的索引，可以添加第三个参数。

【例5.6】添加第二、三个参数（源代码\ch05\5.6.html）。

```html
<div id="app">
    <ul>
        <li v-for="(item,key,index) in nameObj">
            {{index}}--{{key}}--{{item}}
        </li>
    </ul>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                nameObj: {
                    name: "洗衣机",
                    city: "上海",
                    price: "6800元"
                }
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-8所示。

![[插图]](E:\Download\Vue.js 3.0 从入门到精通（视频教学版）\Chapter05\assets\CB_3300020858_Figure-P76_23436.jpg)

图5-8　添加第二、三个参数

3．v-for指令遍历整数

也可以使用v-for指令遍历整数。

【例5.7】v-for指令遍历整数（源代码\ch05\5.7.html）。

```html
<div id="app">
    <span v-for="item in 20">
        {{item}}
    </span>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({}).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-9所示。

![[插图]](assets\CB_3300020858_Figure-P76_23701.jpg)

图5-9　v-for指令遍历整数

4．在<template>上使用v-for

类似于v-if，也可以利用带有v-for的<template>来循环渲染一段包含多个元素的内容。

【例5.8】在<template>上使用v-for（源代码\ch05\5.8.html）。

```html
<div id="app">
    <ul>
        <template v-for="(item,key,index) in nameObj">
            <li>{{index}}--{{key}}--{{item}}</li>
        </template>
    </ul>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                nameObj: {
                    name: "洗衣机",
                    city: "上海",
                    price: "6800元"
                }
            }
        }
    }).mount('#app');
</script>
```

在浏览器中运行程序，按F12键打开控制台并切换到“Elements”选项，并没有看到<template>元素，结果如图5-10所示。

![](assets\CB_3300020858_Figure-P77_24142.jpg)

图5-10　在<template>上使用v-for

> 提示：template元素一般常和v-for和v-if一起结合使用，这样会使得整个HTML结构没有那么多多余的元素，整个结构会更加清晰。

5．数组更新检测

Vue将被监听的数组的变异方法进行了包裹，它们也会触发视图更新。被包裹过的方法包括push()、pop()、shift()、unshift()、splice()、sort()和reverse()。

【例5.9】数组更新检测（源代码\ch05\5.9.html）。

```html
<div id="app">
    <ul>
        <li v-for="(item,index) in nameList">
            {{index}}--{{item}}
        </li>
    </ul>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                nameList: ["洗衣机", "上海", "5800元"]
            }
        }
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-11所示。按F12键打开控制台并切换到“Console”选项，在选项中输入“vm.nameList.push("1800台")”，按下Enter键，数据将添加到nameList数组中，在页面中也显示出添加的内容，如图5-12所示。

![](E:\Download\Vue.js 3.0 从入门到精通（视频教学版）\Chapter05\assets\CB_3300020858_Figure-P78_24562.jpg)

图5-11　初始化效果

![[插图]](assets\CB_3300020858_Figure-P78_24563.jpg)

图5-12　修改数据对象中的数组属性

还有一些非变异方法，例如filter()、concat()和slice()。它们不会改变原始数组，而总是返回一个新数组。当使用非变异方法时，可以用新数组替换旧数组。

继续在浏览器控制台输入“vm.nameList=vm.nameList.concat(["2600台"，"畅销版"])”，把变更后的数组再赋值给Vue实例的nameList，按下Enter键，即可发现页面发生了变化，如图5-13所示。

![[插图]](assets\CB_3300020858_Figure-P78_24567.jpg)

图5-13　使用新数组替换原始数组

可能会认为，这将导致Vue丢弃现有DOM并重新渲染整个列表，但事实并非如此。Vue为了使得DOM元素得到最大范围的重用而实现了一些智能的启发式方法，所以用一个含有相同元素的数组去替换原来的数组，这是非常高效的操作。

在Vue 3.0版本中，可以利用索引直接设置一个数组项，例如修改上面示例：

```html
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                nameList: ["洗衣机", "上海", "5800元"]
            }
        }
    }).mount('#app');
    // 使用索引向数组nameList添加"1800台"
    // vm.nameList[3]="1800台";
</script>
```

在浏览器中运行程序，结果如图5-14所示。

![插图](assets\CB_3300020858_Figure-P78_24563.jpg)

图5-14　通过索引向数组添加元素

从上面结果可以发现，要添加的内容已经添加到数组中了。另外还可以采用以下方法：

```js
//使用数组原型的splice()方法
vm.nameList.splice(0,0,"畅销版");
```

修改上面示例：

```html
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                nameList: ["洗衣机", "上海", "5800元"]
            }
        }
    }).mount('#app');
    //使用数组原型的splice()方法
    vm.nameList.splice(0,0,"畅销版");
</script>
```

在浏览器中运行程序，可发现要添加的内容在页面上已经显示，结果如图5-15所示。

![插图](assets\CB_3300020858_Figure-P80_25218.jpg)

图5-15　使用数组原型的splice()方法

6．key属性

当Vue正在更新使用v-for渲染的元素列表时，它默认使用“就地更新”的策略。如果数据项的顺序被改变，Vue将不会移动DOM元素来匹配数据项的顺序，而是就地更新每个元素，并且确保它们在每个索引位置正确渲染。

为了给Vue一个提示，以便它能跟踪每个节点的身份，从而重用和重新排序现有元素，需要为每项提供一个唯一key属性。

下面我们先来看一下不使用key属性的一个示例。在【例5.10】中，定义一个nameList数组对象，使用v-for指令渲染到页面，同时添加三个输入框和一个添加的按钮，可以通过按钮向数组对象中添加内容。在示例中定义一个add方法，在方法中使用unshift()数组的开头添加元素。

【例5.10】不使用key属性（源代码\ch05\5.10.html）。

```html
<div id="app">
    <div>名称:<input type="text" v-model="names"></div>
    <div>产地:<input type="text" v-model="citys"></div>
    <div>价格:<input type="text" v-model="prices">
        <button v-on:click="add()">添加</button>
    </div>
    <hr>
    <p v-for="item in nameList">
        <input type="checkbox">
        <span>名称:{{item.name}}—产地:{{item.city}}—价格:{{item.price}}</span>
    </p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                names: "",
                citys: "",
                prices: "",
                nameList: [
                    {name: '洗衣机', city: '北京', price: '6800元'},
                    {name: '冰箱', city: '上海', price: '8900元'},
                    {name: '空调', city: '广州', price: '6800元'}
                ]
            }
        },
        methods: {
            add: function () {
                this.nameList.unshift({
                    name: this.names,
                    city: this.citys,
                    price: this.prices
                })
            }
        }
    }).mount('#app');
</script>
```

在浏览器中运行程序，选中列表中的第一个选项，如图5-16所示；然后在输入框中输入新的内容，单击“添加”按钮后，向数组开头添加一组新数据，页面中也相应显示，如图5-17所示。

![](assets\CB_3300020858_Figure-P81_26096.jpg)

图5-16　输入内容

![](assets\CB_3300020858_Figure-P81_26097.jpg)

图5-17　添加后效果

从上面结果可以发现，刚才选择的“洗衣机”变成了新添加的“电视机”。很显然这不是我们想要的结果。产生这种效果的原因就是v-for指令的“就地更新”的策略，只记住了数组勾选选项的索引0，当往数组添加内容的时候，虽然数组长度增加了，但是指令只记得刚开始选择的数组下标，于是就选择了新数组中下标为0的选项。

为了给Vue一个提示，以便它能跟踪每个节点的身份，从而重用和重新排序现有元素，需要为每项提供一个唯一key属性。修改上面示例，在v-for指令的后面添加key属性。代码如下：

```html
<p v-for="item in nameList" v-bind:key="item.name">
    <input type="checkbox">
    <span>名称:{{item.name}}—产地:{{item.city}}—价格:{{item.price}}</span>
</p>
```

此时再重复上面的操作，可以发现已经实现了想要的结果，如图5-18所示。

![[插图]](assets\CB_3300020858_Figure-P82_26186.jpg)

图5-18　使用key属性的结果

7．过滤与排序

在实际开发中，可能一个数组需要在很多地方使用，有些地方是过滤后的数据，而有些地方是重新排列的数组。这种情况下，可以使用计算属性或者方法来返回过滤或排序后的数组。

【例5.11】过滤与排序（源代码\ch05\5.11.html）。

```html
<div id="app">
    <p>所有库存的商品：</p>
    <ul>
        <li v-for="item in nameList">
            {{item}}
        </li>
    </ul>
    <p>产地为上海的商品：</p>
    <ul>
        <li v-for="item in namelists">
            {{item}}
        </li>
    </ul>
    <p>价格大于或等于5000元的商品：</p>
    <ul>
        <li v-for="item in prices()">
            {{item}}
        </li>
    </ul>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                nameList: [
                    {name: "洗衣机", price: "5000", city: "上海"},
                    {name: "冰箱", price: "6800", city: "北京"},
                    {name: "空调", price: "4600", city: "深圳"},
                    {name: "电视机", price: "4900", city: "上海"}
                ]
            }
        },
        computed: {  //计算属性
            namelists: function () {
                return this.nameList.filter(function (nameList) {
                    return nameList.city === "上海";
                })
            }
        },
        methods: {  //方法
            prices: function () {
                return this.nameList.filter(function (nameList) {
                    return nameList.price >= 5000;
                })
            }
        }
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-19所示。

![插图](assets\CB_3300020858_Figure-P83_27215.jpg)

图5-19　过滤与排序

8．v-for与v-if一同使用

v-for与v-if一同使用，当它们处于同一节点上时，v-for的优先级比v-if更高，这意味着v-if将分别重复运行于每个v-for循环中。当只想渲染部分列表选项时，可以使用这种组合方式。

例如【例5.12】所示，循环输出价格大于或等于5000元的商品。

【例5.12】v-for与v-if一同使用（源代码\ch05\5.12.html）。

```html
<div id="app">
    <h3>已经出库的商品</h3>
    <ul>
        <template v-for="goods in goodss">
            <li v-if="goods.isOut">
                {{goods.name}}
            </li>
        </template>
    </ul>
    <h3>没有出库的商品</h3>
    <ul>
        <template v-for="goods in goodss">
            <li v-if="!goods.isOut">
                {{goods.name}}
            </li>
        </template>
    </ul>
</div>
<script src="https://unpkg.com/vue@next"></script>
<script>
    const vm = Vue.createApp({
        data() {
            return {
                goodss: [
                    {name: '洗衣机', isOut: false},
                    {name: '冰箱', isOut: true},
                    {name: '空调', isOut: false},
                    {name: '电视机', isOut: true},
                    {name: '电脑', isOut: false}
                ]
            }
        }
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-20所示。

![](assets\CB_3300020858_Figure-P84_27993.jpg)

图5-20　v-for与v-if一同使用

### 5.1.4　v-bind

v-bind指令主要用于响应更新HTML元素的属性，将一个或多个属性或者一个组件的prop动态绑定到表达式。【例5.13】中，将按钮的title和style属性通过v-bind指令进行绑定，这里对于样式的绑定，需要构建一个对象。其他的对于样式的绑定方法，将在后面的章节中详细介绍。

【例5.13】v-bind指令（源代码\ch05\5.13.html）。

```html
<div id="app">
    <input type="button" value="按钮" v-bind:title="Title" v-bind:style="{color:Color,width:Width+'px'}">
    <p><a :href="Address">超链接</a></p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                Title: '这是我自定义的title属性',
                Color: 'blue',
                Width: '100',
                Address: "https://www.baidu.com/"
            }
        }
    }).mount('#app');
</script>
```

在浏览器中运行程序，按F12键打开控制台并切换到“Elements”选项，可以看到数据已经渲染到了DOM中，结果如图5-21所示。

![](assets\CB_3300020858_Figure-P85_28325.jpg)

图5-21　v-bind指令

### 5.1.5　v-model

v-model指令用来在表单<input>、<textarea>及<select>元素上创建双向数据绑定，它会根据控件类型自动选取正确的方法更新元素。它负责监听用户的输入事件以及更新数据，并对一些极端场景进行特殊处理。

【例5.14】v-model指令（源代码\ch05\5.14.html）。

```html
<div id="app">
    <!--使用v-model指令双向绑定input的值和test属性的值-->
    <p><input v-model="content" type="text"></p>
    <!--显示content的值-->
    <p>{{content}}</p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        data() {
            return {
                content: "空调"
            }
        }
    }).mount('#app');
</script>
```

在浏览器中运行程序，在输入框中输入“空调的价格是4988元”，在输入框下面的位置显示“空调的价格是4988元”，如图5-22所示。

![](assets\CB_3300020858_Figure-P86_28770.jpg)

图5-22　v-model指令此时，在浏览器的控制台中输入：

```html
vm.content
```

按下Enter键，可以看到content属性的值也变成了“空调的价格是4988元”，如图5-23所示。

![](assets\CB_3300020858_Figure-P86_28786.jpg)

图5-23　查看content属性的值

还可以在实例中修改content属性的值，例如在浏览器的控制台中输入下面代码：

```html
vm.content="空调的价格是8900元"
```

然后按下Enter键，可发现页面中的内容也发生变化，如图5-24所示。

![](assets\CB_3300020858_Figure-P87_28832.jpg)

图5-24　v-model指令从上面这个示例可以了解Vue的双向数据绑定，关于v-model指令的更多使用方法，后面的章节中还会详细讲解。

### 5.1.6　v-on

v-on指令用于监听DOM事件，当触发时运行一些JavaScript代码。v-on指令的表达式可以是一般的JavaScript代码，也可以是一个方法的名字或者方法调用语句。

在使用v-on指令对事件进行绑定时，需要在v-on指令后面节上事件名称，例如click、mousedown、mouseup等事件。

【例5.15】v-on指令（源代码\ch05\5.15.html）。

```html
<div id="app">
    <p>
        <!--监听click事件，使用JavaScript语句-->
        <button v-on:click="number-=1">-1</button>
        <span>{{number}}</span>
        <button v-on:click="number+=1">+1</button>
    </p>
    <p>
        <!--监听click事件，绑定方法-->
        <button v-on:click="say()">古诗</button>
    </p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                number: 100
            }
        },
        methods: {
            say: function () {
                alert("曲水浪低蕉叶稳，舞雩风软纻罗轻。")
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，单击“+1”按钮或“-1”按钮，即可实现数字的递增和递减；单击“古诗”按钮，触发click事件，调用say()函数，页面效果如图5-25所示。

![](assets\CB_3300020858_Figure-P88_29450.jpg)

图5-25　v-on指令

在Vue应用中许多事件处理逻辑会很复杂，所以直接把JavaScript代码写在v-on指令中是不可行的，此时就可以使用v-on接收一个方法，把复杂的逻辑放到这个方法中。

> 提示：使用v-on指令接收的方法名称也可以传递参数，只需要在methods中定义方法时说明这个形参，即可在方法中获取到。

### 5.1.7　v-text

v-text指令用来更新元素的文本内容。如果只需要更新部分文本内容，使用插值来完成。

【例5.16】v-text指令（源代码\ch05\5.4.html）。

```html
<div id="app">
    <!--更新部分内容-->
    <p>古诗欣赏:{{message}}</p>
    <!--更新全部内容-->
    <p v-text="message">古诗欣赏:</p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                message: '百舌无言桃李尽，柘林深处鹁鸪鸣。'
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-26所示。

![](assets\CB_3300020858_Figure-P89_29929.jpg)

图5-26　v-text指令

### 5.1.8　v-html

v-html指令用于更新元素的innerHTML。内容按普通HTML插入，不会作为Vue模板进行编译。

【例5.17】v-html指令（源代码\ch05\5.17.html）。

```html
<div id="app">
    <p v-html="message">古诗欣赏:</p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                message: '<h3 style="color:red"> 老去惜花心已懒，爱梅犹绕江村。</h3>'
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-27所示。

![](assets\CB_3300020858_Figure-P89_30299.jpg)

图5-27　v-html指令

> 注意：在网站上动态渲染任意HTML是非常危险的，因为容易导致XSS攻击。只在可信内容上使用v-html，禁止在用户提交的内容上使用v-html指令。

### 5.1.9　v-once

v-once指令不需要表达式。v-once指令只渲染元素和组件一次，随后的渲染，使用了此指令的元素、组件及其所有的子节点，都会当作静态内容并跳过，这可以用于优化更新性能。

例如，在下面示例中，当修改input输入框的值时，使用了v-once指令的p元素，不会随之改变，而第二个p元素跟随着输入框的内容而改变。

【例5.18】v-once指令（源代码\ch05\5.18.html）。

```html
<div id="app">
    <p v-once>不可改变：{{message}}</p>
    <p>可以改变：{{message}}</p>
    <p><input type="text" v-model="message" name=""></p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                message: "苹果"
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，然后在输入框中输入“苹果的库存还有800公斤”，可以看到，添加v-once指令的p标签，并没有任何的变化，效果如图5-28所示。

![](assets\CB_3300020858_Figure-P90_30763.jpg)

图5-28　v-once指令

### 5.1.10　v-pre

v-pre指令不需要表达式，用于跳过这个元素和它的子元素的编译过程。可以使用v-pre指令来显示原始Mustache标签。

【例5.19】v-pre指令（源代码\ch05\5.19.html）。

```html
<div id="app">
    <div v-pre>{{message}}</div>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                message: "竹根流水带溪云。醉中浑不记，归路月黄昏。"
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-29所示。

![](assets\CB_3300020858_Figure-P91_31116.jpg)

图5-29　v-pre指令

### 5.1.11　v-cloak

v-cloak指令不需要表达式。这个指令保持在元素上直到关联实例结束编译。和CSS规则如[v-cloak]{display:none}一起用时，这个指令可以隐藏未编译的Mustache标签直到实例准备完毕。

【例5.20】v-cloak指令（源代码\ch05\5.20.html）。

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>v-cloak</title>
    <!-- 添加 v-cloak 样式 -->
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="app">
    <p v-cloak>{{message}}</p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                message: "竹根流水带溪云。醉中浑不记，归路月黄昏。"
            }
        }
        //在指定的DOM元素上装载应用程序实例的根组件
    }).mount('#app');
</script>
</body>
</html>
```

在浏览器中运行程序，效果如图5-30所示。

![](assets\CB_3300020858_Figure-P92_31703.jpg)

图5-30　v-cloak指令

## 5.2　自定义指令

自定义指令可以用来操作DOM。尽管Vue使用数据驱动视图的理念，但并非所有情况都适合数据驱动。自定义指令就是一种有效的补充和扩展，不仅可用于定义任何的DOM操作，并且是可复用的。在Vue中，除了核心功能默认内置的指令，Vue也允许注册自定义指令。一般情况下，对普通DOM元素进行底层操作，就会用到自定义指令。

### 5.2.1　注册自定义指令

自定义指令的注册方法和组件很像，也分全局注册和局部注册，例如注册一个v-focus的指令，用于在＜input>、＜textarea>元素初始化时自动获得焦点，两种写法分别是：

```js
// 全局注册
const app = Vue.createApp({});
app.directive('focus',{
    // 指令选项
});
// 局部注册
const vm = Vue.createApp({
    directives: {
        'focus',{
            // 指令选项
        }
    }
}).mount('#app');
```

然后可以在模板中任何元素上使用新的v-focus指令，例如：

```html
<input v-focus>
```

### 5.2.2　钩子函数

自定义指令在directives选项中实现，directives选项中提供了以下钩子函数，这些钩子函数是可选的。

（1）bind：只调用一次，指令第一次绑定到元素时调用，用这个钩子函数可以定义一个在绑定时执行一次的初始化动作。

（2）update：被绑定元素所在的模板更新时调用，而无论绑定值是否变化。通过比较更新前后的绑定值，可以忽略不必要的模板更新。

（3）inserted：被绑定元素插入父节点时调用。父节点存在即可调用，不必存在于document中。

（4）componentUpdated：被绑定元素所在模板完成一次更新周期时调用。

（5）unbind：只调用一次，指令与元素解绑时调用。

可以根据需求在不同的钩子函数内完成逻辑代码，例如，上面的v-focus指令，希望在元素插入父节点时就可以调用，最好是使用inserted选项。

【例5.21】自定义v-focus指令（源代码\ch05\5.21.html）。

```html
<div id="app">
    <input v-focus>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({});
    // 注册一个全局自定义指令 `v-focus`
    vm.directive('focus', {
        // 当被绑定的元素插入到DOM中时
        inserted: function (el) {
            // 聚焦元素
            el.focus()
        }
    })
    vm.mount('#app');
</script>
```

在浏览器中运行程序，可以看到，页面将在完成时，输入框自动获取焦点，结果如图5-31所示。

![](assets\CB_3300020858_Figure-P94_32331.jpg)

图5-31　自定义v-focus指令

每个钩子函数都有几个参数可用，例如上面用到的el。它们的含义如下：

（1）el：指令所绑定的元素，可以用来直接操作DOM。

（2）binding：一个对象，包含以下属性：

	*  name：指令名，不包括“v-”前缀。
	*  value：指令的绑定值，例如v-my-directive＝"1+1"，value的值是2。

* oldValue：指令绑定的前一个值，仅在update和componentUpdated钩子中可用。无论值是否改变都可用。
* expression：绑定值的字符串形式。例如v-my-directive="1+1"，expression的值是"1+1"。
*  arg：传给指令的参数。例如v-my-directive：foo，arg的值是foo。
* modifiers：一个包含修饰符的对象。例如v-my-directive.foo.bar，修饰符对象modifiers的值是｛foo:true,bar:true｝。

（3）vnode：Vue编译生成的虚拟节点。

（4）oldVnode：上一个虚拟节点，仅在update和componentUpdated钩子中可用。

> 注意：除了el之外，其他参数都应该是只读的，切勿进行修改。如果需要在钩子之间共享数据，则建议通过元素的dataset来进行。

下面自定义一个指令，在其钩子函数中输入各个参数。

【例5.22】bind钩子函数的参数（源代码\ch05\5.22.html）。

```html
<div id="app">
    <div v-demo:foo.a.b="message"></div>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                message: '海上生明月'
            }
        }
    })
    // 注册一个全局自定义指令 `demo`
    vm.directive('demo', {
        mounted(el, binding, vnode) {
            let s = JSON.stringify
            el.innerHTML =
                'instance: ' + s(binding.instance) + '<br>' +
                'value: ' + s(binding.value) + '<br>' +
                'argument: ' + s(binding.arg) + '<br>' +
                'modifiers: ' + s(binding.modifiers) + '<br>' +
                'vnode keys: ' + Object.keys(vnode).join(', ')
        }
    })
    vm.mount('#app');
</script>
```

在浏览器中运行程序，由于将bind钩子函数的参数信息赋值给了<div>元素的innerHTML属性，所以会在页面中显示bind钩子函数的参数信息，结果如图5-32所示。

![](assets\CB_3300020858_Figure-P95_33096.jpg)

图5-32　bind钩子函数的参数

### 5.2.3　动态指令参数

自定义的指令可以使用动态参数。例如，在v-pin:[direction]="value"中，direction参数可以根据组件实例数据进行更新，从而可以更加灵活地使用自定义指令。

下面例子通过自定义指令来实现一个功能：让某个元素固定在页面中某个位置，在出现滚动条时，元素也不会随着滚动条而滚动。

【例5.23】动态指令参数（源代码\ch05\5.23.html）。

```html
<div id="app">
    <!--直接给出指令的参数-->
    <p v-pin:top="100">林风纤月落</p>
    <!--使用动态参数-->
    <p v-pin:[direction]="100">林风纤月落</p>
</div>
<!--引入vue文件-->
<script src="https://unpkg.com/vue@next"></script>
<script>
    //创建一个应用程序实例
    const vm = Vue.createApp({
        //该函数返回数据对象
        data() {
            return {
                direction: 'left'
            }
        }
    })
    // 注册一个全局自定义指令 `demo`
    vm.directive('pin', {
        beforeMount(el, binding, vnode) {
            el.style.position = 'fixed';
            let s = binding.arg || 'left';
            el.style[s] = binding.value + 'px'
        }
    })
    vm.mount('#app');
</script>
```

在浏览器中运行程序，结果如图5-33所示。

![](assets\CB_3300020858_Figure-P96_33710.jpg)

图5-33　动态指令参数

## 5.3　综合案例——通过指令实现下拉菜单效果

网站主页中经常需要设计下拉菜单，当鼠标移动到某个菜单上时会弹出下拉子菜单列表，每个子菜单项可以链接到不同的页面，当鼠标离开菜单列表时，子菜单项会被隐藏掉。下面就通过指令来设计这样的下拉菜单效果。

【例5.24】设计下拉菜单（源代码\ch05\5.24.html）。

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>下拉菜单</title>
    <style>
        body {
            width: 600px;
        }

        a {
            text-decoration: none;
            display: block;
            color: #fff;
            width: 120px;
            height: 40px;
            line-height: 40px;
            border: 1px solid #fff;
            border-width: 1px 1px 0 0;
            background: #5D478B;
        }

        li {
            list-style-type: none;
        }

        #app > li {
            list-style-type: none;
            float: left;
            text-align: center;
            position: relative;
        }

        #app li a:hover {
            color: #fff;
            background: #FF8C69;
        }

        #app li ul {
            position: absolute;
            left: -40px;
            top: 40px;
            margin-top: 1px;
            font-size: 12px;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <li v-for="menu in menus" @mouseover="menu.show = !menu.show" @mouseout="menu.show = !menu.show">
        <a :href="menu.url">
            {{menu.name}}
        </a>
        <ul v-show="menu.show">
            <li v-for="subMenu in menu.subMenus">
                <a :href="subMenu.url">{{subMenu.name}}</a>
            </li>
        </ul>
    </li>
</div>
<script src="https://unpkg.com/vue@next"></script>
<script>
    const data = {
        menus: [
            {
                name: '在线课程', url: '#', show: false, subMenus: [
                    {name: 'Python课程', url: '#'},
                    {name: 'Java课程', url: '#'},
                    {name: '前端课程', url: '#'}
                ]
            },
            {
                name: '经典图书', url: '#', show: false, subMenus: [
                    {name: 'Python图书', url: '#'},
                    {name: 'Java图书', url: '#'},
                    {name: '前端图书', url: '#'}
                ]
            },
            {
                name: '技术支持', url: '#', show: false, subMenus: [
                    {name: 'Python技术支持', url: '#'},
                    {name: 'Java技术支持', url: '#'},
                    {name: '前端技术支持', url: '#'}
                ]
            },
            {
                name: '关于我们', url: '#', show: false, subMenus: [
                    {name: '团队介绍', url: '#'},
                    {name: '联系我们', url: '#'}
                ]
            }
        ]
    };
    const vm = Vue.createApp({
        data() {
            return data;
        }
    }).mount('#app');
</script>
</body>
</html>
```

在浏览器中运行程序，当鼠标放置在“经典图书”菜单项目时，结果如图5-34所示。

![](assets\Figure-P98_36086.jpg)

图5-34　下拉菜单效果

## 5.4　疑难解惑

疑问1：加载页面时屏幕闪动如何解决？

当网速较慢、Vue.js文件还没加载完时，页面上会显示{{message}}的字样，直到Vue实例创建、模板编译完成后，{{message}}才会被替换，这个过程中屏幕是有闪动的，此时可以使用v-cloak指令和{display:none}来解决这个问题。

疑问2：v-show和v-if指令的不同点是什么？

v-show指令通过修改元素的display属性让其显示或者隐藏。

v-if指令通过直接销毁和重建DOM达到让元素显示和隐藏的效果，v-if可以实现组件的重新渲染。
